
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard Atrasos — v3 (Colores nuevos)</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">

<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --txt:#111827; --muted:#6b7280; --border:#e5e7eb;
    --green:#16a34a; --yellow:#f59e0b; --red:#dc2626; --gray:#6b7280;
  }
  body{ background:var(--bg); color:var(--txt); }
  .card{ background:var(--card); border:1px solid var(--border); box-shadow:0 1px 2px rgba(0,0,0,.04); }
  .badge-soft{ background:#eef2ff; border:1px solid #c7d2fe; color:#3730a3; }
  .chart-wrap{ height:220px; }
  .table thead th{ color:#374151 !important; }
  .dataTables_filter input{ background:#fff; color:#111827; border:1px solid var(--border); }
  .sticky-header{ position:sticky; top:0; z-index:1020; background:var(--bg); padding-top:.5rem; padding-bottom:.5rem;}
  .dot{ display:inline-block; width:.65rem; height:.65rem; border-radius:999px; margin-right:.4rem; vertical-align:middle; }
  .dot.red{ background:var(--red); } .dot.yellow{ background:var(--yellow); } .dot.green{ background:var(--green); } .dot.gray{ background:var(--gray); }
  .badge-outline{ border:1px solid var(--border); background:#fff; padding:.25rem .5rem; border-radius:999px; font-size:.8rem; }
</style>
</head>
<body class="p-3 p-md-4">

<div class="container-fluid">
  <div class="d-flex align-items-center justify-content-between sticky-header">
    <h3 class="m-0">Actividades Pendientes — Semana 37</h3>
    <span class="badge rounded-pill badge-soft">Actualizado: 08-09-2025</span>
  </div>

  <!-- Filtros -->
  <div class="card p-3 mt-2">
    <div class="row g-2">
      <div class="col-12 col-md-4">
        <label class="form-label small text-muted">Proyecto</label>
        <select id="filterProyecto" class="form-select form-select-sm"></select>
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label small text-muted">Etapa de Ingeniería</label>
        <select id="filterEtapa" class="form-select form-select-sm"></select>
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label small text-muted">Mes / Año</label>
        <select id="filterMes" class="form-select form-select-sm"></select>
      </div>
    </div>
  </div>

  <!-- Gráficos -->
  <div class="row g-3 mt-1">
    <div class="col-12 col-lg-4">
      <div class="card p-3">
        <div class="small text-muted mb-2">Atrasos por Proyecto</div>
        <div class="chart-wrap"><canvas id="chartProyectos"></canvas></div>
      </div>
    </div>
    <div class="col-12 col-lg-4">
      <div class="card p-3">
        <div class="small text-muted mb-2">Distribución por Etapa</div>
        <div class="chart-wrap"><canvas id="chartEtapas"></canvas></div>
      </div>
    </div>
    <div class="col-12 col-lg-4">
      <div class="card p-3">
        <div class="small text-muted mb-2">Evolución (Mes/Año)</div>
        <div class="chart-wrap"><canvas id="chartTime"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Tabla -->
  <div class="card p-3 mt-2">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="fw-semibold">Detalle de actividades</div>
      <button id="btnExport" class="btn btn-sm btn-outline-primary">Exportar Excel</button>
    </div>
    <div class="table-responsive">
      <table id="tabla" class="table table-striped table-hover w-100">
        <thead>
          <tr>
            <th>Nombre de tarea</th>
            <th>Plan</th>
            <th>Fecha de vencimiento</th>
            <th>Proyecto</th>
            <th>Etapa Ingenieria</th>
            <th>Mes_Año</th>
            <th>Días de atraso</th>
            <th>Semáforo</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="text-center text-muted mt-3">
    <small>Hecho para Claudio — Gestión de Confiabilidad</small>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>

<script>
const RAW = [{"Nombre de tarea":"10. Confiabilidad","Plan":"NA - ID - C001409 - CTRL PH PLANTA AGUA","Fecha de vencimiento":"2025-09-14","Proyecto":" C001409 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"10. Confiabilidad","Plan":"NA - ID - C001759 - REEMP SOP RODILLO SUCCION","Fecha de vencimiento":"2025-09-14","Proyecto":" C001759 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"10.1. Evaluación comportamiento equipos ante pérdida","Plan":"NA - ID - C001409 - CTRL PH PLANTA AGUA","Fecha de vencimiento":"2025-09-14","Proyecto":" C001409 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"10.1. Evaluación comportamiento equipos ante pérdida","Plan":"NA - ID - C001759 - REEMP SOP RODILLO SUCCION","Fecha de vencimiento":"2025-09-14","Proyecto":" C001759 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"10.2. Evaluación de capacidad eléctrica","Plan":"NA - ID - C001409 - CTRL PH PLANTA AGUA","Fecha de vencimiento":"2025-09-14","Proyecto":" C001409 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"10.2. Evaluación de capacidad eléctrica","Plan":"NA - ID - C001759 - REEMP SOP RODILLO SUCCION","Fecha de vencimiento":"2025-09-14","Proyecto":" C001759 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"10.3. Evaluación de capacidad mecánica vs requerida y\/o","Plan":"NA - ID - C001409 - CTRL PH PLANTA AGUA","Fecha de vencimiento":"2025-09-14","Proyecto":" C001409 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"10.3. Evaluación de capacidad mecánica vs requerida y\/o","Plan":"NA - ID - C001759 - REEMP SOP RODILLO SUCCION","Fecha de vencimiento":"2025-09-14","Proyecto":" C001759 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"11. Formación y Procedimientos","Plan":"L2 - ID - C000448 - Prexor DS38 - Etapa 2 (11 Silenciadores)","Fecha de vencimiento":"2025-09-04","Proyecto":" C000448 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"11.1. Presentar proyecto a Planta","Plan":"L2 - ID - C000448 - Prexor DS38 - Etapa 2 (11 Silenciadores)","Fecha de vencimiento":"2025-09-04","Proyecto":" C000448 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"11.2. Definir criterios de capacitación operacional y de m","Plan":"L2 - ID - C000448 - Prexor DS38 - Etapa 2 (11 Silenciadores)","Fecha de vencimiento":"2025-09-04","Proyecto":" C000448 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"12.1. Levantamiento planes de mantenimiento base de c","Plan":"L2 - ID - C000448 - Prexor DS38 - Etapa 2 (11 Silenciadores)","Fecha de vencimiento":"2025-09-04","Proyecto":" C000448 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"12.2. Levantamiento planes de mantenimiento vendor","Plan":"L2 - ID - C000448 - Prexor DS38 - Etapa 2 (11 Silenciadores)","Fecha de vencimiento":"2025-09-04","Proyecto":" C000448 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"12.3. Consolidado de planes de mantenimiento proyecto","Plan":"L2 - ID - C000448 - Prexor DS38 - Etapa 2 (11 Silenciadores)","Fecha de vencimiento":"2025-09-06","Proyecto":" C000448 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"12.4. Envio de planes mantenimiento hacia Confiabilidad","Plan":"PV - ID - C001129 - Nuevo Concentrador 1D","Fecha de vencimiento":"2025-09-07","Proyecto":" C001129 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"12.4. Envio de planes mantenimiento hacia Confiabilidad","Plan":"L2 - ID - C000448 - Prexor DS38 - Etapa 2 (11 Silenciadores)","Fecha de vencimiento":"2025-09-11","Proyecto":" C000448 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"12.7. Envio de planes de mantenimiento a Planificación L","Plan":"L3 - ID - C001776.02 - CONF PROT COMP L3","Fecha de vencimiento":"2025-09-02","Proyecto":" C001776.02","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"12.8. Confirmación de planes de mantenimiento creados","Plan":"NA - ID - C001488CM - COCCIÓN MODIFICADA PLANTA","Fecha de vencimiento":"2025-06-17","Proyecto":" C001488CM","Etapa Ingeniera":" ID ","Mes_Año":"2025-06"},{"Nombre de tarea":"13. Cierre de proyecto","Plan":"L2 - ID - C000868 - SIST RCI EN EQ HIDRAUL Y DETEC E","Fecha de vencimiento":"2025-06-08","Proyecto":" C000868 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-06"},{"Nombre de tarea":"13. Cierre de proyecto","Plan":"PC - ID - C001380 - REEMPLAZO INTERCAMBIADOR CA","Fecha de vencimiento":"2025-06-22","Proyecto":" C001380 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-06"},{"Nombre de tarea":"13. Cierre de proyecto","Plan":"PC - ID - C000889 - Reducción de consumo de álcali en","Fecha de vencimiento":"2025-08-29","Proyecto":" C000889 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-08"},{"Nombre de tarea":"13. Cierre de proyecto","Plan":"NA - ID - C000928 - Interruptores incoming de centros","Fecha de vencimiento":"2025-09-05","Proyecto":" C000928 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"13. Cierre de proyecto","Plan":"NA - ID - C001488CM - COCCIÓN MODIFICADA PLANTA","Fecha de vencimiento":"2025-09-09","Proyecto":" C001488CM","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"13.1. Incorporacion de documentos y planos mas relevan","Plan":"L2 - ID - C000868 - SIST RCI EN EQ HIDRAUL Y DETEC E","Fecha de vencimiento":"2025-05-19","Proyecto":" C000868 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-05"},{"Nombre de tarea":"13.1. Incorporacion de documentos y planos mas relevan","Plan":"NA - ID - C001488CM - COCCIÓN MODIFICADA PLANTA","Fecha de vencimiento":"2025-08-19","Proyecto":" C001488CM","Etapa Ingeniera":" ID ","Mes_Año":"2025-08"},{"Nombre de tarea":"13.1. Incorporacion de documentos y planos mas relevan","Plan":"L3 - ID - C001774 - TALLER SOLDADURA","Fecha de vencimiento":"2025-09-01","Proyecto":" C001774 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"13.1. Incorporacion de documentos y planos mas relevan","Plan":"PC - ID - C000984 - Cumplimiento de seguridades en sa","Fecha de vencimiento":"2025-09-01","Proyecto":" C000984 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"13.2. Incorporacion de planes de mantenimiento","Plan":"L2 - ID - C000868 - SIST RCI EN EQ HIDRAUL Y DETEC E","Fecha de vencimiento":"2025-05-19","Proyecto":" C000868 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-05"},{"Nombre de tarea":"13.2. Incorporacion de planes de mantenimiento","Plan":"NA - ID - C001488CM - COCCIÓN MODIFICADA PLANTA","Fecha de vencimiento":"2025-08-19","Proyecto":" C001488CM","Etapa Ingeniera":" ID ","Mes_Año":"2025-08"},{"Nombre de tarea":"13.2. Incorporacion de planes de mantenimiento","Plan":"L3 - ID - C001774 - TALLER SOLDADURA","Fecha de vencimiento":"2025-09-01","Proyecto":" C001774 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"13.2. Incorporacion de planes de mantenimiento","Plan":"PC - ID - C000984 - Cumplimiento de seguridades en sa","Fecha de vencimiento":"2025-09-01","Proyecto":" C000984 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"13.3. Incorporacion de formulario de TAG, UT y Equipos","Plan":"L2 - ID - C000868 - SIST RCI EN EQ HIDRAUL Y DETEC E","Fecha de vencimiento":"2025-05-19","Proyecto":" C000868 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-05"},{"Nombre de tarea":"13.3. Incorporacion de formulario de TAG, UT y Equipos","Plan":"NA - ID - C001488CM - COCCIÓN MODIFICADA PLANTA","Fecha de vencimiento":"2025-08-19","Proyecto":" C001488CM","Etapa Ingeniera":" ID ","Mes_Año":"2025-08"},{"Nombre de tarea":"13.3. Incorporacion de formulario de TAG, UT y Equipos","Plan":"L3 - ID - C001774 - TALLER SOLDADURA","Fecha de vencimiento":"2025-09-01","Proyecto":" C001774 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"13.3. Incorporacion de formulario de TAG, UT y Equipos","Plan":"PC - ID - C000984 - Cumplimiento de seguridades en sa","Fecha de vencimiento":"2025-09-01","Proyecto":" C000984 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"13.4. Incorporacion de codigo sap nuevos","Plan":"L2 - ID - C000868 - SIST RCI EN EQ HIDRAUL Y DETEC E","Fecha de vencimiento":"2025-05-19","Proyecto":" C000868 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-05"},{"Nombre de tarea":"13.4. Incorporacion de codigo sap nuevos","Plan":"NA - ID - C001488CM - COCCIÓN MODIFICADA PLANTA","Fecha de vencimiento":"2025-08-19","Proyecto":" C001488CM","Etapa Ingeniera":" ID ","Mes_Año":"2025-08"},{"Nombre de tarea":"13.4. Incorporacion de codigo sap nuevos","Plan":"L3 - ID - C001774 - TALLER SOLDADURA","Fecha de vencimiento":"2025-09-01","Proyecto":" C001774 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"13.4. Incorporacion de codigo sap nuevos","Plan":"PC - ID - C000984 - Cumplimiento de seguridades en sa","Fecha de vencimiento":"2025-09-01","Proyecto":" C000984 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"13.5. Información de HandOver","Plan":"L2 - ID - C000868 - SIST RCI EN EQ HIDRAUL Y DETEC E","Fecha de vencimiento":"2025-06-06","Proyecto":" C000868 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-06"},{"Nombre de tarea":"13.5. Información de HandOver","Plan":"PC - ID - C001380 - REEMPLAZO INTERCAMBIADOR CA","Fecha de vencimiento":"2025-06-20","Proyecto":" C001380 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-06"},{"Nombre de tarea":"13.5. Información de HandOver","Plan":"PC - ID - C000889 - Reducción de consumo de álcali en","Fecha de vencimiento":"2025-08-29","Proyecto":" C000889 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-08"},{"Nombre de tarea":"13.5. Información de HandOver","Plan":"NA - ID - C001488CM - COCCIÓN MODIFICADA PLANTA","Fecha de vencimiento":"2025-09-07","Proyecto":" C001488CM","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"13.6. Envío de correo a Planta","Plan":"L2 - ID - C000868 - SIST RCI EN EQ HIDRAUL Y DETEC E","Fecha de vencimiento":"2025-06-08","Proyecto":" C000868 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-06"},{"Nombre de tarea":"13.6. Envío de correo a Planta","Plan":"PC - ID - C001380 - REEMPLAZO INTERCAMBIADOR CA","Fecha de vencimiento":"2025-06-22","Proyecto":" C001380 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-06"},{"Nombre de tarea":"13.6. Envío de correo a Planta","Plan":"NA - ID - C001488CM - COCCIÓN MODIFICADA PLANTA","Fecha de vencimiento":"2025-09-09","Proyecto":" C001488CM","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"14. Validación compra repuestos","Plan":"L2 - ID - C000868 - SIST RCI EN EQ HIDRAUL Y DETEC E","Fecha de vencimiento":"2025-05-20","Proyecto":" C000868 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-05"},{"Nombre de tarea":"14. Validación compra repuestos","Plan":"L3 - ID - C001774 - TALLER SOLDADURA","Fecha de vencimiento":"2025-09-02","Proyecto":" C001774 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"14.1 Revisar la compra de repuestos vs lo recomendado","Plan":"L2 - ID - C000868 - SIST RCI EN EQ HIDRAUL Y DETEC E","Fecha de vencimiento":"2025-05-20","Proyecto":" C000868 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-05"},{"Nombre de tarea":"14.1 Revisar la compra de repuestos vs lo recomendado","Plan":"L3 - ID - C001774 - TALLER SOLDADURA","Fecha de vencimiento":"2025-09-02","Proyecto":" C001774 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"2. Acceso a documentos y planos","Plan":"PC - IB - C001975 - RENOV. COLECTORES RILES","Fecha de vencimiento":"2025-09-03","Proyecto":" C001975 ","Etapa Ingeniera":" IB ","Mes_Año":"2025-09"},{"Nombre de tarea":"2.1 Acceso a DM","Plan":"PC - IB - C001975 - RENOV. COLECTORES RILES","Fecha de vencimiento":"2025-08-28","Proyecto":" C001975 ","Etapa Ingeniera":" IB ","Mes_Año":"2025-08"},{"Nombre de tarea":"3.7 Revisión #3 Mantenibilidad (75%)","Plan":"NA - IB - SSOLMED - TREN INTEGRADO","Fecha de vencimiento":"2025-09-09","Proyecto":" SSOLMED ","Etapa Ingeniera":" IB ","Mes_Año":"2025-09"},{"Nombre de tarea":"4.1 Desarrollo de RBD del proyecto","Plan":"PC - IB - C001844 - SPCI UH","Fecha de vencimiento":"2025-08-18","Proyecto":" C001844 ","Etapa Ingeniera":" IB ","Mes_Año":"2025-08"},{"Nombre de tarea":"4.1 Desarrollo de RBD del proyecto","Plan":"PC - IB - C000714 - NORMALIZAR EQ. Y SSEE PTA AGUA","Fecha de vencimiento":"2025-09-08","Proyecto":" C000714 ","Etapa Ingeniera":" IB ","Mes_Año":"2025-09"},{"Nombre de tarea":"4.2 Definir requerimiento de redundancia o stand by","Plan":"PC - IB - C001844 - SPCI UH","Fecha de vencimiento":"2025-09-03","Proyecto":" C001844 ","Etapa Ingeniera":" IB ","Mes_Año":"2025-09"},{"Nombre de tarea":"5.5 Confirmación de UTs creadas en SAP","Plan":"NA - ID - C001765 - PROY. CANCHA OLIVOS","Fecha de vencimiento":"2025-09-11","Proyecto":" C001765 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"6. Gestion creacion de equipos","Plan":"NA - ID - C001409 - CTRL PH PLANTA AGUA","Fecha de vencimiento":"2025-09-01","Proyecto":" C001409 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"6.1 Levantamiento de repuestos para cambios preventiv","Plan":"L3 - ID - C001960 - MEJORA SIST. ALIM. BIOMASA","Fecha de vencimiento":"2025-09-09","Proyecto":" C001960 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"6.3. Envío de formulario a Planta","Plan":"NA - ID - C001409 - CTRL PH PLANTA AGUA","Fecha de vencimiento":"2025-08-26","Proyecto":" C001409 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-08"},{"Nombre de tarea":"6.4. Confirmación de equipos creados en SAP","Plan":"NA - ID - C001409 - CTRL PH PLANTA AGUA","Fecha de vencimiento":"2025-09-01","Proyecto":" C001409 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"7. Gestion creación de repuestos","Plan":"L3 - ID - C001849 - MEJORA CIRCUITO SOPLADORES","Fecha de vencimiento":"2025-09-09","Proyecto":" C001849 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"7.3. Busqueda, creacion, extension de SKU","Plan":"L3 - ID - C001774 - TALLER SOLDADURA","Fecha de vencimiento":"2025-08-24","Proyecto":" C001774 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-08"},{"Nombre de tarea":"7.4. Confirmación de todos los SKU creados","Plan":"L3 - ID - C001849 - MEJORA CIRCUITO SOPLADORES","Fecha de vencimiento":"2025-09-01","Proyecto":" C001849 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"7.4. Confirmación de todos los SKU creados","Plan":"L3 - ID - C001774 - TALLER SOLDADURA","Fecha de vencimiento":"2025-09-01","Proyecto":" C001774 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"7.4. Confirmación de todos los SKU creados","Plan":"L3 - ID - C001552.01 - INC CAP TORRE ENFRIAMIENTO","Fecha de vencimiento":"2025-09-01","Proyecto":" C001552.01","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"7.5. Creacion de BOM del proyecto","Plan":"NA - ID - C000856 - Nuevo Compresor Aire y Upgrade","Fecha de vencimiento":"2025-09-08","Proyecto":" C000856 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"7.5. Creacion de BOM del proyecto","Plan":"L3 - ID - C001849 - MEJORA CIRCUITO SOPLADORES","Fecha de vencimiento":"2025-09-09","Proyecto":" C001849 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"7.5. Creacion de BOM del proyecto","Plan":"L3 - ID - C001774 - TALLER SOLDADURA","Fecha de vencimiento":"2025-09-09","Proyecto":" C001774 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"7.5. Creacion de BOM del proyecto","Plan":"L3 - ID - C001552.01 - INC CAP TORRE ENFRIAMIENTO","Fecha de vencimiento":"2025-09-09","Proyecto":" C001552.01","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"8.3. Desarrollo de planes de acción","Plan":"NA - ID - C001828.01 - UPGRADE PRENSA D2","Fecha de vencimiento":"2025-08-05","Proyecto":" C001828.01","Etapa Ingeniera":" ID ","Mes_Año":"2025-08"},{"Nombre de tarea":"8.4. Cierre de FMEA con respaldos","Plan":"NA - ID - C001409 - CTRL PH PLANTA AGUA","Fecha de vencimiento":"2025-09-03","Proyecto":" C001409 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"8.4. Cierre de FMEA con respaldos","Plan":"NA - ID - C001828.01 - UPGRADE PRENSA D2","Fecha de vencimiento":"2025-09-05","Proyecto":" C001828.01","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"8.4. Cierre de FMEA con respaldos","Plan":"L3 - ID - C001774 - TALLER SOLDADURA","Fecha de vencimiento":"2025-09-08","Proyecto":" C001774 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"8.4. Cierre de FMEA con respaldos","Plan":"PV - ID - C001129 - Nuevo Concentrador 1D","Fecha de vencimiento":"2025-09-13","Proyecto":" C001129 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"9. Mantenibilidad","Plan":"NA - ID - C001765 - PROY. CANCHA OLIVOS","Fecha de vencimiento":"2025-09-10","Proyecto":" C001765 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"9.1. Revisión de espacios adecuados para realizar mante","Plan":"NA - ID - C001765 - PROY. CANCHA OLIVOS","Fecha de vencimiento":"2025-09-10","Proyecto":" C001765 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"9.2. Revisión de equipamiento adicional requerido","Plan":"NA - ID - C001765 - PROY. CANCHA OLIVOS","Fecha de vencimiento":"2025-09-10","Proyecto":" C001765 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"},{"Nombre de tarea":"9.3. Revisión de capacidad de entrega de equipos en ser","Plan":"NA - ID - C001765 - PROY. CANCHA OLIVOS","Fecha de vencimiento":"2025-09-10","Proyecto":" C001765 ","Etapa Ingeniera":" ID ","Mes_Año":"2025-09"}]  
  const PALETTE = ['#0ea5e9','#22c55e','#f59e0b','#ef4444','#8b5cf6','#06b6d4','#84cc16','#f43f5e','#14b8a6','#a3a3a3'];
  function hexToRgba(hex, a=1){
    const h = hex.replace('#','');
    const bigint = parseInt(h, 16);
    const r = (bigint >> 16) & 255;
    const g = (bigint >> 8) & 255;
    const b = bigint & 255;
    return `rgba(${r}, ${g}, ${b}, ${a})`;
  }
  function colorsFor(n, alpha=0.25){ 
    const out = [];
    for (let i=0;i<n;i++){ out.push(hexToRgba(PALETTE[i % PALETTE.length], alpha)); }
    return out;
  }

  function onlyUnique(value, index, array) { return array.indexOf(value) === index; }
  function fmtDate(iso) {
    if(!iso) return "";
    const d = new Date(iso);
    if (isNaN(d)) return "";
    const day = String(d.getDate()).padStart(2,'0');
    const mon = String(d.getMonth()+1).padStart(2,'0');
    const yr  = d.getFullYear();
    return `${day}/${mon}/${yr}`;
  }
  function daysOverdue(iso){
    if(!iso) return 0;
    const due = new Date(iso);
    if (isNaN(due)) return 0;
    const today = new Date();
    const d0 = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const d1 = new Date(due.getFullYear(), due.getMonth(), due.getDate());
    return Math.max(Math.floor((d0 - d1)/(1000*60*60*24)), 0);
  }
  function semaforoLabel(days){
    if (days > 30) return {txt:"Crítico", cls:"red"};
    if (days >= 8) return {txt:"Alto", cls:"yellow"};
    return {txt:"Moderado", cls:"green"};
  }

  // Persistencia de filtros
  const FILTER_KEYS = ["filterProyecto","filterEtapa","filterMes"];
  function saveFilters() { FILTER_KEYS.forEach(k => localStorage.setItem(k, document.getElementById(k).value)); }
  function loadFilters() { FILTER_KEYS.forEach(k => { const v = localStorage.getItem(k) || ""; const el = document.getElementById(k); if (el) el.value = v; }); }

  // Enriquecer dataset
  const DATA = RAW.map(r => {
    const d = daysOverdue(r["Fecha de vencimiento"]);
    const s = semaforoLabel(d || 0);
    return {
      "Nombre de tarea": r["Nombre de tarea"],
      "Plan": r["Plan"],
      "Fecha de vencimiento": r["Fecha de vencimiento"],
      "Proyecto": r["Proyecto"] || "",
      "Etapa Ingenieria": r["Etapa Ingenieria"] || "",
      "Mes_Año": r["Mes_Año"] || "",
      "Días de atraso": d,
      "_semaforo_cls": s.cls,
      "Semáforo": s.txt
    };
  });

  // Poblar selects
  function fillSelect(sel, values) {
    const el = document.getElementById(sel);
    el.innerHTML = '<option value="">(Todos)</option>' + values.filter(onlyUnique).sort().map(v => `<option value="${v}">${v}</option>`).join("");
  }
  fillSelect("filterProyecto", DATA.map(r => r["Proyecto"] || "(sin proyecto)"));
  fillSelect("filterEtapa", DATA.map(r => r["Etapa Ingenieria"] || "(sin etapa)"));
  fillSelect("filterMes", DATA.map(r => r["Mes_Año"] || ""));
  loadFilters();

  // Tabla
  const table = new DataTable('#tabla', {
    data: DATA.map(r => [
      r["Nombre de tarea"],
      r["Plan"],
      fmtDate(r["Fecha de vencimiento"]),
      r["Proyecto"],
      r["Etapa Ingenieria"],
      r["Mes_Año"],
      r["Días de atraso"],
      `<span class="dot ${r._semaforo_cls}"></span><span class="badge-outline">${r["Semáforo"]}</span>`
    ]),
    columns: [
      { title: "Nombre de tarea" },
      { title: "Plan" },
      { title: "Fecha de vencimiento" },
      { title: "Proyecto" },
      { title: "Etapa Ingenieria" },
      { title: "Mes_Año" },
      { title: "Días de atraso" },
      { title: "Semáforo" }
    ],
    order: [[6, "desc"]],
    pageLength: 15,
    dom: 'Bfrtip',
    buttons: [{ extend: 'excelHtml5', title: 'actividades_atrasadas' }]
  });

  document.getElementById("btnExport").addEventListener("click", () => table.button('.buttons-excel').trigger());

  // Filtros
  function applyFilters() {
    const p  = document.getElementById("filterProyecto").value;
    const e  = document.getElementById("filterEtapa").value;
    const m  = document.getElementById("filterMes").value;

    table.columns(3).search(p ? '^'+p.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&')+'$' : '', true, false);
    table.columns(4).search(e ? '^'+e.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&')+'$' : '', true, false);
    table.columns(5).search(m ? '^'+m.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&')+'$' : '', true, false);
    table.draw();

    saveFilters();

    const idxs = table.rows({search: 'applied'}).indexes().toArray();
    const filtered = idxs.map(i => ({
      "Nombre de tarea": table.cell(i,0).data(),
      "Plan": table.cell(i,1).data(),
      "Fecha": table.cell(i,2).data(),
      "Proyecto": table.cell(i,3).data(),
      "Etapa": table.cell(i,4).data(),
      "Mes_Año": table.cell(i,5).data()
    }));
    refreshKpisAndCharts(filtered);
  }
  ["filterProyecto","filterEtapa","filterMes"].forEach(id => { document.getElementById(id).addEventListener("change", applyFilters); });

  // KPIs y Gráficos (con paleta nueva)
  let chartProj, chartEtapas, chartTime;
  function refreshKpisAndCharts(rows) {
    // KPIs (si están en la página)
    const kp1 = document.getElementById("kpi_total");
    if (kp1) kp1.textContent = rows.length;
    const kp2 = document.getElementById("kpi_proyectos");
    const kp3 = document.getElementById("kpi_etapas");
    const kp4 = document.getElementById("kpi_mescritico");

    const projU = rows.map(r => r["Proyecto"] || "(sin proyecto)").filter(onlyUnique).length;
    const etaU  = rows.map(r => r["Etapa"] || "(sin etapa)").filter(onlyUnique).length;
    const countByMes = rows.reduce((acc, r) => (acc[r["Mes_Año"]] = (acc[r["Mes_Año"]]||0)+1, acc), {});
    const crit = Object.entries(countByMes).sort((a,b) => b[1]-a[1])[0];
    if (kp2) kp2.textContent = projU;
    if (kp3) kp3.textContent = etaU;
    if (kp4) kp4.textContent = crit ? `${crit[0]} (${crit[1]})` : "-";

    const byProyecto = rows.reduce((acc, r) => (acc[r["Proyecto"]||"(sin proyecto)"] = (acc[r["Proyecto"]||"(sin proyecto)"]||0)+1, acc), {});
    const projLabels = Object.keys(byProyecto);
    const projValues = Object.values(byProyecto);

    const byEtapa = rows.reduce((acc, r) => (acc[r["Etapa"]||"(sin etapa)"] = (acc[r["Etapa"]||"(sin etapa)"]||0)+1, acc), {});
    const etapaLabels = Object.keys(byEtapa);
    const etapaValues = Object.values(byEtapa);

    const byMes = rows.reduce((acc, r) => (acc[r["Mes_Año"]] = (acc[r["Mes_Año"]]||0)+1, acc), {});
    const mesLabels = Object.keys(byMes).sort();
    const mesValues = mesLabels.map(k => byMes[k]);

    const barColors = colorsFor(projLabels.length, 0.35);
    const pieColors = colorsFor(etapaLabels.length, 0.85);
    const lineColor = PALETTE[0];
    const lineFill  = hexToRgba(PALETTE[0], 0.20);

    const optBar = {responsive: true, maintainAspectRatio:false, plugins: { legend: { display:false } }};
    const optPie = {responsive: true, maintainAspectRatio:false, plugins: { legend: { labels: { boxWidth:12 } } }};
    const optLine= {responsive: true, maintainAspectRatio:false, plugins: { legend: { display:false } }};

    if (chartProj) chartProj.destroy();
    if (chartEtapas) chartEtapas.destroy();
    if (chartTime) chartTime.destroy();

    chartProj = new Chart(document.getElementById('chartProyectos'), {
      type: 'bar',
      data: { labels: projLabels, datasets: [{ data: projValues, backgroundColor: barColors, borderColor: barColors.map(c => c.replace(/0\.\d+/, '1')), borderWidth:1 }] },
      options: optBar
    });

    chartEtapas = new Chart(document.getElementById('chartEtapas'), {
      type: 'pie',
      data: { labels: etapaLabels, datasets: [{ data: etapaValues, backgroundColor: pieColors, borderColor: pieColors.map(c => c.replace(/0\.\d+/, '1')), borderWidth:1 }] },
      options: optPie
    });

    chartTime = new Chart(document.getElementById('chartTime'), {
      type: 'line',
      data: { labels: mesLabels, datasets: [{ data: mesValues, borderColor: lineColor, backgroundColor: lineFill, fill: true, tension: 0.35, pointRadius: 3 }] },
      options: optLine
    });
  }

  // Inicializar
  window.addEventListener("DOMContentLoaded", () => {
    const all = RAW.map(r => ({
      "Nombre de tarea": r["Nombre de tarea"],
      "Plan": r["Plan"],
      "Fecha": fmtDate(r["Fecha de vencimiento"]),
      "Proyecto": r["Proyecto"] || "",
      "Etapa": r["Etapa Ingenieria"] || "",
      "Mes_Año": r["Mes_Año"] || ""
    }));
    refreshKpisAndCharts(all);
    applyFilters();
  });
</script>

</body>
</html>
